<!DOCTYPE html>
<html lang="zh-TW">
    <head>
        <title>手術紀錄查詢</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU"
            crossorigin="anonymous"
        />
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <link
            href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
            rel="stylesheet"
        />
        <style>
            :root {
                --primary-color: #005eb8;
                --secondary-color: #4d9f0c;
            }

            body {
                padding-top: 3%;
                font-size: 18px;
                font-family: "Roboto", sans-serif;
                background: #f4f4f4;
            }

            .container {
                background: white;
                padding: 20px;
                border-radius: 5px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            }

            h2 {
                color: var(--primary-color);
            }

            input[type="text"] {
                border: 2px solid var(--primary-color);
                border-radius: 0.25rem;
                margin-right: 1rem;
            }

            .btn-danger {
                background-color: var(--primary-color);
                border: none;
                border-radius: 0.25rem;
                width: 100px;
            }

            table {
                width: 100%;
                border-collapse: collapse;
            }

            table,
            th,
            td {
                border: 1px solid lightgray;
            }

            th {
                background-color: var(--secondary-color);
                color: black;
                text-align: center;
                vertical-align: middle;
            }

            td {
                padding: 10px;
                text-align: center;
                vertical-align: middle;
            }

            .error {
                color: red;
                margin: 10px 0;
            }

            #loading {
                display: none;
                text-align: center;
            }

            .chart-container {
                display: flex;
                justify-content: center;
                align-items: center;
                height: 400px;
                /* Adjust height as needed */
            }

            .carousel {
                position: relative;
            }

            .carousel-control-prev,
            .carousel-control-next {
                width: 3rem;
                height: 3rem;
                border-radius: 50%;
                background-color: transparent;
                border: none;
                position: absolute;
                top: 0;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .carousel-control-prev {
                left: calc(50% - 40rem);
            }

            .carousel-control-next {
                left: calc(50% + 38rem);
            }

            .carousel-control-prev-icon,
            .carousel-control-next-icon {
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 2rem;
                /* 增加箭頭的字體大小 */
                color: #343a40;
                /* 深灰色箭頭 */
                color: #343a40;
                /* 深灰色箭頭 */
                font-weight: bold;
                /* 設置粗體 */
            }

            .carousel-control-prev-icon:after {
                content: "‹";
            }

            .carousel-control-next-icon:after {
                content: "›";
            }
        </style>
    </head>

    <body>
        <div class="container">
            <h2 class="text-center mb-4">手術記錄查詢</h2>
            <div class="row justify-content-center">
                <div class="col-md-11 col-lg-9">
                    <div class="mb-3 d-flex">
                        <input
                            type="text"
                            class="form-control"
                            name="t1"
                            placeholder="輸入關鍵字"
                        />
                        <button
                            type="button"
                            onclick="searchRecords()"
                            class="btn btn-danger"
                        >
                            查詢
                        </button>
                    </div>
                    <div id="loading" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <div
                        id="recordCarousel"
                        class="carousel slide"
                        data-bs-ride="carousel"
                        data-bs-interval="false"
                    >
                        <div class="carousel-inner">
                            <div class="carousel-item active">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead class="table-light">
                                            <tr>
                                                <th>ID</th>
                                                <th>手術名稱</th>
                                                <th>病人性別</th>
                                                <th>病人年齡</th>
                                                <th>手術總結</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- 搜索結果將在此填充 -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="carousel-item">
                                <div class="chart-container">
                                    <canvas id="genderChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <button
                            class="carousel-control-prev"
                            type="button"
                            data-bs-target="#recordCarousel"
                            data-bs-slide="prev"
                        >
                            <span
                                class="carousel-control-prev-icon"
                                aria-hidden="true"
                            ></span>
                            <span class="visually-hidden">上一頁</span>
                        </button>
                        <button
                            class="carousel-control-next"
                            type="button"
                            data-bs-target="#recordCarousel"
                            data-bs-slide="next"
                        >
                            <span
                                class="carousel-control-next-icon"
                                aria-hidden="true"
                            ></span>
                            <span class="visually-hidden">下一頁</span>
                        </button>
                    </div>
                    <div class="error" id="error-message"></div>
                </div>
            </div>
        </div>

        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ"
            crossorigin="anonymous"
        ></script>
        <script>
            function searchRecords() {
                let keyword = document.querySelector('input[name="t1"]').value;
                document.getElementById("loading").style.display = "block";
                fetch("/search-results", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ keyword: keyword }),
                })
                    .then((response) => response.json())
                    .then((data) => {
                        document.getElementById("loading").style.display =
                            "none";
                        let tableBody = document.querySelector("tbody");
                        tableBody.innerHTML = "";
                        data.forEach((record) => {
                            let tr = document.createElement("tr");
                            tr.innerHTML = `
                        <td>${record.id}</td>
                        <td>${record.surgery_name}</td>
                        <td>${record.patient_gender}</td>
                        <td>${record.patient_age}</td>
                        <td>${record.surgery_summary}</td>
                        `;
                            tableBody.appendChild(tr);
                        });
                        createGenderChart(data);
                    })
                    .catch((error) => {
                        document.getElementById("loading").style.display =
                            "none";
                        console.error("Error:", error);
                    });
            }

            let genderChart;

            function createGenderChart(data) {
                if (genderChart) {
                    genderChart.destroy();
                }
                const genderData = {
                    male: data.filter(
                        (record) => record.patient_gender === "男"
                    ).length,
                    female: data.filter(
                        (record) => record.patient_gender === "女"
                    ).length,
                    other: data.filter(
                        (record) =>
                            record.patient_gender !== "男" &&
                            record.patient_gender !== "女"
                    ).length,
                };

                const ctx = document
                    .getElementById("genderChart")
                    .getContext("2d");
                genderChart = new Chart(ctx, {
                    type: "pie",
                    data: {
                        labels: ["男", "女", "其他"],
                        datasets: [
                            {
                                label: "性別比例",
                                data: [
                                    genderData.male,
                                    genderData.female,
                                    genderData.other,
                                ],
                                backgroundColor: [
                                    "rgba(54, 162, 235, 0.6)",
                                    "rgba(255, 99, 132, 0.6)",
                                    "rgba(255, 206, 86, 0.6)",
                                ],
                                borderColor: [
                                    "rgba(54, 162, 235, 1)",
                                    "rgba(255,99,132,1)",
                                    "rgba(255, 206, 86, 1)",
                                ],
                                borderWidth: 1,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                    },
                });
            }
        </script>
    </body>
</html>
