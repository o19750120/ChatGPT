<!DOCTYPE html>
<html lang="zh-TW">
    <head>
        <title>手術紀錄查詢</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU"
            crossorigin="anonymous"
        />
        <link
            href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
            rel="stylesheet"
        />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <!-- Google Fonts Link For Icons -->
        <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0"
        />
        <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,1,0"
        />
        <link
            rel="stylesheet"
            href="{{ url_for('static', filename='style.css') }}"
        />
        <style>
            :root {
                --primary-color: #005eb8;
                --secondary-color: #4d9f0c;
            }
            body {
                padding-top: 3%;
                font-size: 18px;
                font-family: "Roboto", sans-serif;
                background: #f4f4f4;
            }
            .container {
                background: white;
                padding: 20px;
                border-radius: 5px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
                max-width: 85%; /* 或者您可以使用更大的百分比或像素值 */
                margin: auto; /* 居中顯示 */
            }
            h2 {
                color: var(--primary-color);
            }
            input[type="text"] {
                border: 2px solid var(--primary-color);
                border-radius: 0.25rem;
                margin-right: 1rem;
            }

            .btn {
                margin: 0 10px; /* 每個按鈕左右增加10px的邊距 */
                font-family: "Roboto", sans-serif; /* 確保使用相同的字體 */
                font-size: 16px; /* 統一字體大小 */
                font-weight: 500; /* 統一字體加粗程度，可根據需要調整 */
                color: white; /* 設定所有按鈕文字為黑色 */
            }
            .btn-info {
                color: white; /* 設定文字顏色為白色 */
                text-decoration: none; /* 移除超連結的下劃線 */
                display: flex; /* 使用flex布局 */
                justify-content: center; /* 水平居中 */
                align-items: center; /* 垂直居中 */
                background-color: #17a2b8; /* 初始藍色背景 */
            }

            .btn-info:hover,
            .btn-info:focus {
                color: white; /* 懸停和聚焦時保持白色文字 */
                text-decoration: none; /* 移除超連結的下劃線 */
                background-color: #0d5d69; /* 懸停或聚焦時的更深藍色背景 */
            }
            .form-select + .form-control {
                /* 選擇器後的輸入框 */
                margin-left: 10px; /* 給查詢按鈕左側增加邊距 */
            }
            .btn-info {
                background-color: #17a2b8; /* Bootstrap 藍色背景，根據需要可調整 */
                border: none; /* 移除邊框 */
            }
            .btn-primary,
            .btn-danger {
                border: none;
                border-radius: 0.25rem;
                margin-right: 10px;
            }
            table {
                width: 100%;
                border-collapse: collapse;
            }
            table,
            th,
            td {
                border: 1px solid lightgray;
            }
            th {
                background-color: var(--secondary-color);
                color: black;
                text-align: center;
                vertical-align: middle;
            }
            td {
                padding: 10px;
                text-align: center;
                vertical-align: middle;
            }
            .error {
                color: red;
                margin: 10px 0;
            }
            #loading {
                display: none;
                text-align: center;
            }
            /* Style the modal */
            .modal {
                display: none; /* Hidden by default */
                position: fixed; /* Stay in place */
                z-index: 1; /* Sit on top */
                left: 0;
                top: 0;
                width: 100%; /* Full width */
                height: 100%; /* Full height */
                overflow: auto; /* Enable scroll if needed */
                background-color: rgb(0, 0, 0); /* Fallback color */
                background-color: rgba(0, 0, 0, 0.4); /* Black w/ opacity */
                padding-top: 60px; /* Location of the box */
            }
            /* Modal Content */
            .modal-content {
                background-color: #fefefe;
                margin: auto;
                padding: 20px;
                border: 1px solid #888;
                width: 50%; /* Could be more or less, depending on screen size */
            }
            /* The Close Button */
            .close {
                color: #aaaaaa;
                float: right;
                font-size: 28px;
                font-weight: bold;
            }
            .close:hover,
            .close:focus {
                color: #000;
                text-decoration: none;
                cursor: pointer;
            }
            #start-recording-btn {
                color: black; /* 設定按鈕文字顏色為黑色 */
                border-radius: 0.25rem; /* 統一設定四個角的圓角大小 */
            }

            /* 確保所有按鈕的圓角一致性 */
            .btn {
                border-radius: 0.25rem; /* 統一所有按鈕的圓角大小 */
            }

            /* 聊天機器人的樣式 */
            .chatbot {
                width: 100%; /* 或設置為頁面寬度的特定百分比 */
                background: #fff;
                border: 1px solid #ccc; /* 輕微的邊框 */
                border-radius: 10px;
                overflow: hidden;
                margin-top: 20px; /* 與上方元素的間隔 */
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* 輕微的陰影效果 */
            }

            .chatbox {
                height: auto; /* 自動高度 */
                max-height: 300px; /* 最大高度，可滾動 */
                overflow-y: auto; /* 超過時可滾動 */
                padding: 20px; /* 內間距 */
            }

            /* 調整對話框內部樣式 */
            .chatbox .chat {
                display: flex;
                list-style: none;
                margin-bottom: 10px;
            }

            .chatbox .outgoing {
                justify-content: flex-end;
            }

            .chatbox .incoming span {
                width: 32px;
                height: 32px;
                color: #fff;
                cursor: default;
                text-align: center;
                line-height: 32px;
                align-self: flex-end;
                background: #724ae8;
                border-radius: 4px;
                margin: 0 10px 7px 0;
            }

            .chatbox .chat p {
                white-space: pre-wrap;
                padding: 12px 16px;
                border-radius: 10px;
                max-width: 75%;
                font-size: 0.95rem;
            }

            .chatbox .incoming p {
                background: #f2f2f2;
                color: #000;
                border-radius: 10px 10px 10px 0;
            }

            .chatbox .outgoing p {
                background: #724ae8;
                color: #fff;
                border-radius: 10px 10px 0 10px;
            }

            .chatbox .chat p.error {
                color: #721c24;
                background: #f8d7da;
            }

            /* 調整輸入區域樣式 */
            .chatbot .chat-input {
                display: flex;
                gap: 5px;
                position: relative;
                width: 100%;
                background: #fff;
                padding: 10px;
                border-top: 1px solid #ddd;
            }

            .chat-input textarea {
                height: 55px;
                width: calc(100% - 50px); /* 為發送按鈕留出空間 */
                border: none;
                outline: none;
                resize: none;
                padding: 15px;
                font-size: 0.95rem;
                border-radius: 5px;
                background: #f4f4f4;
            }

            #send-btn {
                width: 40px; /* 按鈕寬度 */
                height: 40px; /* 按鈕高度 */
                background-color: #005eb8; /* 設置按鈕背景色 */
                color: white; /* 設置按鈕文字顏色 */
                text-align: center;
                line-height: 40px; /* 垂直居中 */
                cursor: pointer;
                border-radius: 5px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            /* 調整滾動條樣式 */
            .chatbot :where(.chatbox, textarea)::-webkit-scrollbar {
                width: 6px;
            }

            .chatbot :where(.chatbox, textarea)::-webkit-scrollbar-track {
                background: #fff;
                border-radius: 25px;
            }

            .chatbot :where(.chatbox, textarea)::-webkit-scrollbar-thumb {
                background: #ccc;
                border-radius: 25px;
            }

            /* 針對小螢幕的調整 */
            @media (max-width: 490px) {
                .chatbot {
                    width: 100%;
                    border-radius: 0;
                }
                .chatbot .chatbox {
                    max-height: 200px;
                    padding: 15px;
                }
                .chatbot .chat-input {
                    padding: 10px;
                }
            }
        </style>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    </head>
    <body>
        <div class="container">
            <h2 class="text-center mb-4">手術記錄查詢</h2>
            <div class="row justify-content-center">
                <div class="col-md-11 col-lg-9">
                    <div class="mb-3 d-flex">
                        <select
                            class="form-select"
                            name="surgeryNumber"
                            style="margin-right: 1rem"
                        >
                            <option value="">選擇手術序號</option>
                            <!-- Options will be dynamically added here -->
                        </select>
                        <textarea
                            class="form-control"
                            name="t1"
                            placeholder="輸入關鍵字"
                            rows="5"
                        >
                        1. Surgery Name and Postoperative Diagnosis
                        Surgery Name: Not explicitly mentioned in the provided record.
                        Postoperative Diagnosis: Not provided in the record. It typically includes the final assessment of the patient's condition after surgery but requires specific medical information not included here.
                        2. Patient Preparation and Operating Room Setup
                        Patient Preparation: The patient was placed in a supine position under ETGA (presumably Endotracheal General Anesthesia).
                        Operating Room Setup: The operation field was disinfected and draped in the usual manner. A pneumatic tourniquet was prepared and inflated after exsanguination.
                        3. Surgical Entry and Procedure
                        Surgical Entry: An anterior incision was made at the distal wrist crease along the radial border of the flexor carpi radialis tendon and extended 6 cm proximally.
                        Procedure:
                        Identification and protection of the flexor carpi radialis tendon and radial artery.
                        Incision of the deep fascia between the tendon and artery.
                        Division of the pronator quadratus at its radial insertion.
                        Retractors were placed on both sides of the radius.
                        Reduction of the fracture.
                        Fixation of the fracture with AO VARY ANGLE LDRP (a type of orthopedic hardware).
                        4. Wound Treatment and Surgery Conclusion
                        Wound Treatment: The wound closure process is not detailed but mentioned as being completed in a routine fashion.
                        Surgery Conclusion: The record concludes with the wound being closed, but does not provide post-surgery care or patient status.
                    </textarea
                        >
                        <button
                            type="button"
                            onclick="searchRecords()"
                            class="btn btn-primary"
                        >
                            查詢
                        </button>
                        <button
                            type="button"
                            onclick="saveChanges()"
                            class="btn btn-success"
                        >
                            儲存更改
                        </button>
                        <a href="/test-db" target="_blank" class="btn btn-info"
                            >資料庫</a
                        >
                        <!-- 新增的按鈕 -->
                    </div>
                    <div id="loading" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <div
                        id="saving-loading"
                        class="text-center"
                        style="display: none"
                    >
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>

                    <div class="chatbot">
                        <ul class="chatbox">
                            <li class="chat incoming">
                                <span class="material-symbols-outlined"
                                    >smart_toy</span
                                >
                                <p>我是你的醫療助手</p>
                            </li>
                        </ul>
                        <div class="chat-input">
                            <textarea
                                placeholder="請輸入文字"
                                spellcheck="false"
                                required
                            ></textarea>
                            <span id="send-btn" class="material-symbols-rounded"
                                >send</span
                            >
                        </div>
                    </div>

                    <div class="input-group mb-3">
                        <button
                            id="start-recording-btn"
                            class="btn btn-outline-primary"
                            onclick="toggleRecording()"
                        >
                            開始錄音
                        </button>

                        <input
                            type="text"
                            id="transcript"
                            class="form-control"
                            placeholder="請按下開始錄音按鈕"
                        />
                    </div>

                    <div class="table-responsive">
                        <table class="table">
                            <thead class="table-light">
                                <tr>
                                    <th>手術序號</th>
                                    <th>病歷號</th>
                                    <th>手術真實細節</th>
                                    <th>ChatGPT手術紀錄（內建）</th>
                                    <th>備註</th>
                                    <!-- 新增的欄位 -->
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Search results will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ"
            crossorigin="anonymous"
        ></script>
        <script>
            // JavaScript code for fetching surgery numbers and searching records
            document.addEventListener("DOMContentLoaded", function () {
                fetch("/get-surgery-numbers")
                    .then((response) => response.json())
                    .then((data) => {
                        let surgeryNumberSelect = document.querySelector(
                            'select[name="surgeryNumber"]'
                        );
                        data.forEach((num) => {
                            let option = document.createElement("option");
                            option.value = num;
                            option.textContent = num;
                            surgeryNumberSelect.appendChild(option);
                        });
                    })
                    .catch((error) => console.error("Error:", error));
            });

            function searchRecords() {
                let surgeryNumber = document.querySelector(
                    'select[name="surgeryNumber"]'
                ).value;
                let keyword = document.querySelector(
                    'textarea[name="t1"]'
                ).value;
                document.getElementById("loading").style.display = "block";

                fetch("/search-results", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        surgery_number: surgeryNumber,
                        keyword: keyword,
                    }),
                })
                    .then((response) => response.json())
                    .then((records) => {
                        document.getElementById("loading").style.display =
                            "none";
                        let tableBody = document.querySelector("tbody");
                        tableBody.innerHTML = ""; // Clear existing table content

                        records.forEach((record) => {
                            let tr = document.createElement("tr");
                            tr.innerHTML = `
                            <td>${record.ODR_LOGN}</td>
                            <td>${record.ODR_CHRT}</td>
                            <td>${record.ODR_OPP}</td>
                            <td>${record.ChatGPT_Surgery_Record || "N/A"}</td>
                            <td contenteditable="true"></td>
                        `;
                            tableBody.appendChild(tr);
                            // 將查詢結果作為消息發送
                            simulateUserInputAndSend(
                                `${record.ChatGPT_Surgery_Record || "無結果"}`
                            );
                        });
                    })
                    .catch((error) => {
                        document.getElementById("loading").style.display =
                            "none";
                        console.error("Error:", error);
                        document.getElementById("error-message").textContent =
                            "無法加載數據，請檢查後端服務。";
                    });
            }

            function simulateUserInputAndSend(message) {
                const chatInput = document.querySelector(
                    ".chat-input textarea"
                );
                chatInput.value = message; // 將消息填入輸入框
                handleChat(); // 模擬點擊發送按鈕
            }

            function saveChanges() {
                const tableRows = document.querySelectorAll("table tbody tr");
                const updates = [];

                tableRows.forEach((row) => {
                    const surgeryNumber = row.cells[0].innerText;
                    const newRecord = row.cells[4].innerText;
                    updates.push({ surgeryNumber, newRecord });
                });

                // 顯示加載動畫
                document.getElementById("saving-loading").style.display =
                    "block";

                fetch("/save-changes", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(updates),
                })
                    .then((response) => {
                        if (!response.ok) {
                            throw new Error("Network response was not ok");
                        }
                        return response.json();
                    })
                    .then((data) => {
                        console.log("Success:", data);
                        // 隱藏加載動畫
                        document.getElementById(
                            "saving-loading"
                        ).style.display = "none";
                    })
                    .catch((error) => {
                        console.error("Error:", error);
                        // 隱藏加載動畫
                        document.getElementById(
                            "saving-loading"
                        ).style.display = "none";
                    });
            }
        </script>
        <script>
            var recognition;
            var transcript = document.getElementById("transcript");
            var recordingBtn = document.getElementById("start-recording-btn");

            var isRecording = false; // 用於追蹤是否正在錄音

            if (!("webkitSpeechRecognition" in window)) {
                alert("您的瀏覽器不支援語音辨識功能");
            } else {
                recognition = new webkitSpeechRecognition();

                // 設定辨識的相關屬性
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = "cmn-Hant-TW";

                recognition.onstart = function () {
                    console.log("開始辨識...");
                };

                recognition.onend = function () {
                    console.log("停止辨識!");
                    isRecording = false;
                    recordingBtn.innerText = "開始錄音";
                    recordingBtn.classList.remove("btn-outline-danger");
                    recordingBtn.classList.add("btn-outline-primary");
                };

                recognition.onresult = function (event) {
                    var i = event.resultIndex;
                    var j = event.results[i].length - 1;
                    transcript.value = event.results[i][j].transcript;
                };
            }

            function toggleRecording() {
                if (isRecording) {
                    recognition.stop();
                } else {
                    recognition.start();
                    isRecording = true;
                    recordingBtn.innerText = "錄音中，點擊停止";
                    recordingBtn.classList.remove("btn-outline-primary");
                    recordingBtn.classList.add("btn-outline-danger");
                }
            }
        </script>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                fetch("/config")
                    .then((response) => response.json())
                    .then((config) => {
                        window.API_KEY = config.apiKey;

                        initChat();
                    })
                    .catch((error) =>
                        console.error("Error fetching config:", error)
                    );
            });

            const chatbotToggler = document.querySelector(".chatbot-toggler");
            const closeBtn = document.querySelector(".close-btn");
            const chatbox = document.querySelector(".chatbox");
            const chatInput = document.querySelector(".chat-input textarea");
            const sendChatBtn = document.querySelector(".chat-input span");

            let userMessage = null;
            const inputInitHeight = chatInput.scrollHeight;

            const createChatLi = (message, className) => {
                const chatLi = document.createElement("li");
                chatLi.classList.add("chat", `${className}`);
                let chatContent =
                    className === "outgoing"
                        ? `<p></p>`
                        : `<span class="material-symbols-outlined">smart_toy</span><p></p>`;
                chatLi.innerHTML = chatContent;
                chatLi.querySelector("p").textContent = message;
                return chatLi;
            };

            function generateResponse(userMessage) {
                fetch("/chat", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ message: userMessage }),
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        const responseMessage =
                            data.choices[0].message.content.trim();
                        const incomingChatLi = createChatLi(
                            responseMessage,
                            "incoming"
                        );
                        chatbox.appendChild(incomingChatLi);
                        chatbox.scrollTo(0, chatbox.scrollHeight);
                    })
                    .catch((error) => {
                        const errorMessage =
                            error.message || "An unknown error occurred.";
                        const errorChatLi = createChatLi(
                            `Error: ${errorMessage}`,
                            "incoming"
                        );
                        chatbox.appendChild(errorChatLi);
                        chatbox.scrollTo(0, chatbox.scrollHeight);
                    });
            }

            function handleChat() {
                let userMessage = chatInput.value.trim();

                if (!userMessage) {
                    console.error("No user message to send.");
                    return;
                }

                chatInput.value = "";
                chatInput.style.height = `${inputInitHeight}px`;

                const outgoingChatLi = createChatLi(userMessage, "outgoing");
                chatbox.appendChild(outgoingChatLi);
                chatbox.scrollTo(0, chatbox.scrollHeight);

                setTimeout(() => {
                    generateResponse(userMessage);
                }, 600);
            }

            chatInput.addEventListener("input", () => {
                chatInput.style.height = `${inputInitHeight}px`;
                chatInput.style.height = `${chatInput.scrollHeight}px`;
            });

            chatInput.addEventListener("keydown", (e) => {
                if (
                    e.key === "Enter" &&
                    !e.shiftKey &&
                    window.innerWidth > 800
                ) {
                    e.preventDefault();
                    handleChat();
                }
            });

            sendChatBtn.addEventListener("click", handleChat);
            closeBtn.addEventListener("click", () =>
                document.body.classList.remove("show-chatbot")
            );
            chatbotToggler.addEventListener("click", () =>
                document.body.classList.toggle("show-chatbot")
            );
        </script>
    </body>
</html>
