<!DOCTYPE html>
<html lang="zh-TW">
    <head>
        <title>æ‰‹è¡“ç´€éŒ„æŸ¥è©¢</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU"
            crossorigin="anonymous"
        />

        <link
            href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
            rel="stylesheet"
        />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <!-- Google Fonts Link For Icons -->
        <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0"
        />
        <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,1,0"
        />
        <link
            rel="stylesheet"
            href="{{ url_for('static', filename='style.css') }}"
        />
        <style>
            :root {
                --primary-color: #005eb8;
                --secondary-color: #4d9f0c;
            }
            body {
                padding-top: 3%;
                font-size: 18px;
                font-family: "Roboto", sans-serif;
                background: #f4f4f4;
            }
            .container {
                background: white;
                padding: 20px;
                border-radius: 5px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
                max-width: 85%; /* æˆ–è€…æ‚¨å¯ä»¥ä½¿ç”¨æ›´å¤§çš„ç™¾åˆ†æ¯”æˆ–åƒç´ å€¼ */
                margin: auto; /* å±…ä¸­æ˜¾ç¤º */
            }
            h2 {
                color: var(--primary-color);
            }
            input[type="text"] {
                border: 2px solid var(--primary-color);
                border-radius: 0.25rem;
                margin-right: 1rem;
            }

            .btn {
                margin: 0 10px; /* æ¯å€‹æŒ‰éˆ•å·¦å³å¢åŠ 10pxçš„é‚Šè· */
                font-family: "Roboto", sans-serif; /* ç¢ºä¿ä½¿ç”¨ç›¸åŒçš„å­—é«” */
                font-size: 16px; /* çµ±ä¸€å­—é«”å¤§å° */
                font-weight: 500; /* çµ±ä¸€å­—é«”åŠ ç²—ç¨‹åº¦ï¼Œå¯æ ¹æ“šéœ€è¦èª¿æ•´ */
                color: white; /* è¨­å®šæ‰€æœ‰æŒ‰éˆ•æ–‡å­—ç‚ºé»‘è‰² */
            }
            .btn-info {
                color: white; /* è¨­å®šæ–‡å­—é¡è‰²ç‚ºç™½è‰² */
                text-decoration: none; /* ç§»é™¤è¶…é€£çµçš„ä¸‹åŠƒç·š */
                display: flex; /* ä½¿ç”¨flexå¸ƒå±€ */
                justify-content: center; /* æ°´å¹³å±…ä¸­ */
                align-items: center; /* å‚ç›´å±…ä¸­ */
                background-color: #17a2b8; /* åˆå§‹è—è‰²èƒŒæ™¯ */
            }

            .btn-info:hover,
            .btn-info:focus {
                color: white; /* æ‡¸åœå’Œèšç„¦æ™‚ä¿æŒç™½è‰²æ–‡å­— */
                text-decoration: none; /* ç§»é™¤è¶…é€£çµçš„ä¸‹åŠƒç·š */
                background-color: #0d5d69; /* æ‡¸åœæˆ–èšç„¦æ™‚çš„æ›´æ·±è—è‰²èƒŒæ™¯ */
            }
            .form-select + .form-control {
                /* é¸æ“‡å™¨å¾Œçš„è¼¸å…¥æ¡† */
                margin-left: 10px; /* çµ¦æŸ¥è©¢æŒ‰éˆ•å·¦å´å¢åŠ é‚Šè· */
            }
            .btn-info {
                background-color: #17a2b8; /* Bootstrap è—è‰²èƒŒæ™¯ï¼Œæ ¹æ“šéœ€è¦å¯èª¿æ•´ */
                border: none; /* ç§»é™¤é‚Šæ¡† */
            }
            .btn-primary,
            .btn-danger {
                border: none;
                border-radius: 0.25rem;
                margin-right: 10px;
            }
            table {
                width: 100%;
                border-collapse: collapse;
            }
            table,
            th,
            td {
                border: 1px solid lightgray;
            }
            th {
                background-color: var(--secondary-color);
                color: black;
                text-align: center;
                vertical-align: middle;
            }
            td {
                padding: 10px;
                text-align: center;
                vertical-align: middle;
            }
            .error {
                color: red;
                margin: 10px 0;
            }
            #loading {
                display: none;
                text-align: center;
            }
            /* Style the modal */
            .modal {
                display: none; /* Hidden by default */
                position: fixed; /* Stay in place */
                z-index: 1; /* Sit on top */
                left: 0;
                top: 0;
                width: 100%; /* Full width */
                height: 100%; /* Full height */
                overflow: auto; /* Enable scroll if needed */
                background-color: rgb(0, 0, 0); /* Fallback color */
                background-color: rgba(0, 0, 0, 0.4); /* Black w/ opacity */
                padding-top: 60px; /* Location of the box */
            }
            /* Modal Content */
            .modal-content {
                background-color: #fefefe;
                margin: auto;
                padding: 20px;
                border: 1px solid #888;
                width: 50%; /* Could be more or less, depending on screen size */
            }
            /* The Close Button */
            .close {
                color: #aaaaaa;
                float: right;
                font-size: 28px;
                font-weight: bold;
            }
            .close:hover,
            .close:focus {
                color: #000;
                text-decoration: none;
                cursor: pointer;
            }
            #start-recording-btn {
                color: black; /* è¨­å®šæŒ‰éˆ•æ–‡å­—é¡è‰²ç‚ºé»‘è‰² */
                border-radius: 0.25rem; /* çµ±ä¸€è¨­å®šå››å€‹è§’çš„åœ“è§’å¤§å° */
            }

            /* ç¢ºä¿æ‰€æœ‰æŒ‰éˆ•çš„åœ“è§’ä¸€è‡´æ€§ */
            .btn {
                border-radius: 0.25rem; /* çµ±ä¸€æ‰€æœ‰æŒ‰éˆ•çš„åœ“è§’å¤§å° */
            }
        </style>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    </head>
    <body>
        <div class="container">
            <h2 class="text-center mb-4">æ‰‹è¡“è¨˜éŒ„æŸ¥è©¢</h2>
            <div class="row justify-content-center">
                <div class="col-md-11 col-lg-9">
                    <div class="mb-3 d-flex">
                        <select
                            class="form-select"
                            name="surgeryNumber"
                            style="margin-right: 1rem"
                        >
                            <option value="">é¸æ“‡æ‰‹è¡“åºè™Ÿ</option>
                            <!-- Options will be dynamically added here -->
                        </select>
                        <textarea
                            class="form-control"
                            name="t1"
                            placeholder="è¼¸å…¥é—œéµå­—"
                            rows="5"
                        >
                            1. Surgery Name and Postoperative Diagnosis
                            Surgery Name: Not explicitly mentioned in the provided record.
                            Postoperative Diagnosis: Not provided in the record. It typically includes the final assessment of the patient's condition after surgery but requires specific medical information not included here.
                            2. Patient Preparation and Operating Room Setup
                            Patient Preparation: The patient was placed in a supine position under ETGA (presumably Endotracheal General Anesthesia).
                            Operating Room Setup: The operation field was disinfected and draped in the usual manner. A pneumatic tourniquet was prepared and inflated after exsanguination.
                            3. Surgical Entry and Procedure
                            Surgical Entry: An anterior incision was made at the distal wrist crease along the radial border of the flexor carpi radialis tendon and extended 6 cm proximally.
                            Procedure:
                            Identification and protection of the flexor carpi radialis tendon and radial artery.
                            Incision of the deep fascia between the tendon and artery.
                            Division of the pronator quadratus at its radial insertion.
                            Retractors were placed on both sides of the radius.
                            Reduction of the fracture.
                            Fixation of the fracture with AO VARY ANGLE LDRP (a type of orthopedic hardware).
                            4. Wound Treatment and Surgery Conclusion
                            Wound Treatment: The wound closure process is not detailed but mentioned as being completed in a routine fashion.
                            Surgery Conclusion: The record concludes with the wound being closed, but does not provide post-surgery care or patient status.
                                        </textarea
                        >
                        <button
                            type="button"
                            onclick="searchRecords()"
                            class="btn btn-primary"
                        >
                            æŸ¥è©¢
                        </button>
                        <button
                            type="button"
                            onclick="saveChanges()"
                            class="btn btn-success"
                        >
                            å„²å­˜æ›´æ”¹
                        </button>
                        <a href="/test-db" target="_blank" class="btn btn-info"
                            >è³‡æ–™åº«</a
                        >
                        <!-- æ–°å¢çš„æŒ‰éˆ• -->
                    </div>
                    <div id="loading" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <div
                        id="saving-loading"
                        class="text-center"
                        style="display: none"
                    >
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>

                    <div class="input-group mb-3">
                        <button
                            id="start-recording-btn"
                            class="btn btn-outline-primary"
                            onclick="toggleRecording()"
                        >
                            é–‹å§‹éŒ„éŸ³
                        </button>

                        <input
                            type="text"
                            id="transcript"
                            class="form-control"
                            placeholder="è«‹æŒ‰ä¸‹é–‹å§‹éŒ„éŸ³æŒ‰éˆ•"
                        />
                    </div>

                    <div class="chatbot">
                        <ul class="chatbox">
                            <li class="chat incoming">
                                <span class="material-symbols-outlined"
                                    >smart_toy</span
                                >
                                <p>ä½ å¥½ ğŸ‘‹<br />æœ‰ä»€éº¼éœ€è¦å¹«æ‚¨çš„å¿™?</p>
                            </li>
                        </ul>
                        <div class="chat-input">
                            <textarea
                                placeholder="è«‹è¼¸å…¥æ–‡å­—"
                                spellcheck="false"
                                required
                            ></textarea>
                            <span id="send-btn" class="material-symbols-rounded"
                                >send</span
                            >
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table">
                            <thead class="table-light">
                                <tr>
                                    <th>æ‰‹è¡“åºè™Ÿ</th>
                                    <th>ç—…æ­·è™Ÿ</th>
                                    <th>æ‰‹è¡“çœŸå¯¦ç´°ç¯€</th>
                                    <th>ChatGPTæ‰‹è¡“ç´€éŒ„</th>
                                    <th>å‚™è¨»</th>
                                    <!-- æ–°å¢çš„æ¬„ä½ -->
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Search results will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ"
            crossorigin="anonymous"
        ></script>
        <script>
            // JavaScript code for fetching surgery numbers and searching records
            document.addEventListener("DOMContentLoaded", function () {
                fetch("/get-surgery-numbers")
                    .then((response) => response.json())
                    .then((data) => {
                        let surgeryNumberSelect = document.querySelector(
                            'select[name="surgeryNumber"]'
                        );
                        data.forEach((num) => {
                            let option = document.createElement("option");
                            option.value = num;
                            option.textContent = num;
                            surgeryNumberSelect.appendChild(option);
                        });
                    })
                    .catch((error) => console.error("Error:", error));
            });

            function searchRecords() {
                let surgeryNumber = document.querySelector(
                    'select[name="surgeryNumber"]'
                ).value;
                let keyword = document.querySelector(
                    'textarea[name="t1"]'
                ).value;
                document.getElementById("loading").style.display = "block";

                fetch("/search-results", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        surgery_number: surgeryNumber,
                        keyword: keyword,
                    }),
                })
                    .then((response) => response.json())
                    .then((records) => {
                        document.getElementById("loading").style.display =
                            "none";
                        let tableBody = document.querySelector("tbody");
                        tableBody.innerHTML = ""; // Clear existing table content

                        records.forEach((record) => {
                            let tr = document.createElement("tr");
                            tr.innerHTML = `
                            <td>${record.ODR_LOGN}</td>
                            <td>${record.ODR_CHRT}</td>
                            <td>${record.ODR_OPP}</td>
                            <td>${record.ChatGPT_Surgery_Record || "N/A"}</td>
                            <td contenteditable="true"></td> <!-- æ–°å¢çš„å¯ç·¨è¼¯ç©ºç™½æ¬„ä½ -->
                        `;
                            tableBody.appendChild(tr);
                        });
                    })
                    .catch((error) => {
                        document.getElementById("loading").style.display =
                            "none";
                        console.error("Error:", error);
                        document.getElementById("error-message").textContent =
                            "ç„¡æ³•è¼‰å…¥æ•¸æ“šï¼Œè«‹æª¢æŸ¥å¾Œç«¯æœå‹™ã€‚";
                    });
            }
            function saveChanges() {
                const tableRows = document.querySelectorAll("table tbody tr");
                const updates = [];

                tableRows.forEach((row) => {
                    const surgeryNumber = row.cells[0].innerText;
                    const newRecord = row.cells[4].innerText;
                    updates.push({ surgeryNumber, newRecord });
                });

                // é¡¯ç¤ºåŠ è¼‰å‹•ç•«
                document.getElementById("saving-loading").style.display =
                    "block";

                fetch("/save-changes", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(updates),
                })
                    .then((response) => {
                        if (!response.ok) {
                            throw new Error("Network response was not ok");
                        }
                        return response.json();
                    })
                    .then((data) => {
                        console.log("Success:", data);
                        // éš±è—åŠ è¼‰å‹•ç•«
                        document.getElementById(
                            "saving-loading"
                        ).style.display = "none";
                    })
                    .catch((error) => {
                        console.error("Error:", error);
                        // éš±è—åŠ è¼‰å‹•ç•«
                        document.getElementById(
                            "saving-loading"
                        ).style.display = "none";
                    });
            }
        </script>
        <script>
            var recognition;
            var transcript = document.getElementById("transcript");
            var recordingBtn = document.getElementById("start-recording-btn");

            var isRecording = false; // ç”¨æ–¼è¿½è¹¤æ˜¯å¦æ­£åœ¨éŒ„éŸ³

            if (!("webkitSpeechRecognition" in window)) {
                alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜åŠŸèƒ½");
            } else {
                recognition = new webkitSpeechRecognition();

                // è¨­å®šè¾¨è­˜çš„ç›¸é—œå±¬æ€§
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = "cmn-Hant-TW";

                recognition.onstart = function () {
                    console.log("é–‹å§‹è¾¨è­˜...");
                };

                recognition.onend = function () {
                    console.log("åœæ­¢è¾¨è­˜!");
                    isRecording = false;
                    recordingBtn.innerText = "é–‹å§‹éŒ„éŸ³";
                    recordingBtn.classList.remove("btn-outline-danger");
                    recordingBtn.classList.add("btn-outline-primary");
                };

                recognition.onresult = function (event) {
                    var i = event.resultIndex;
                    var j = event.results[i].length - 1;
                    transcript.value = event.results[i][j].transcript;
                };
            }

            function toggleRecording() {
                if (isRecording) {
                    recognition.stop();
                } else {
                    recognition.start();
                    isRecording = true;
                    recordingBtn.innerText = "éŒ„éŸ³ä¸­ï¼Œé»æ“Šåœæ­¢";
                    recordingBtn.classList.remove("btn-outline-primary");
                    recordingBtn.classList.add("btn-outline-danger");
                }
            }
        </script>
        <script src="{{ url_for('static', filename='script.js') }}"></script>
    </body>
</html>
