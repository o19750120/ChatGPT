<!DOCTYPE html>
<html lang="zh-TW">
    <head>
        <title>手術紀錄查詢</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU"
            crossorigin="anonymous"
        />
        <link
            href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
            rel="stylesheet"
        />
        <style>
            :root {
                --primary-color: #005eb8;
                --secondary-color: #4d9f0c;
            }
            body {
                padding-top: 3%;
                font-size: 18px;
                font-family: "Roboto", sans-serif;
                background: #f4f4f4;
            }
            .container {
                background: white;
                padding: 20px;
                border-radius: 5px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
                max-width: 85%; /* 或者您可以使用更大的百分比或像素值 */
                margin: auto; /* 居中显示 */
            }
            h2 {
                color: var(--primary-color);
            }
            input[type="text"] {
                border: 2px solid var(--primary-color);
                border-radius: 0.25rem;
                margin-right: 1rem;
            }
            .btn-primary,
            .btn-danger {
                background-color: var(--primary-color);
                border: none;
                border-radius: 0.25rem;
                margin-right: 10px;
            }
            table {
                width: 100%;
                border-collapse: collapse;
            }
            table,
            th,
            td {
                border: 1px solid lightgray;
            }
            th {
                background-color: var(--secondary-color);
                color: black;
                text-align: center;
                vertical-align: middle;
            }
            td {
                padding: 10px;
                text-align: center;
                vertical-align: middle;
            }
            .error {
                color: red;
                margin: 10px 0;
            }
            #loading {
                display: none;
                text-align: center;
            }
            /* Style the modal */
            .modal {
                display: none; /* Hidden by default */
                position: fixed; /* Stay in place */
                z-index: 1; /* Sit on top */
                left: 0;
                top: 0;
                width: 100%; /* Full width */
                height: 100%; /* Full height */
                overflow: auto; /* Enable scroll if needed */
                background-color: rgb(0, 0, 0); /* Fallback color */
                background-color: rgba(0, 0, 0, 0.4); /* Black w/ opacity */
                padding-top: 60px; /* Location of the box */
            }
            /* Modal Content */
            .modal-content {
                background-color: #fefefe;
                margin: auto;
                padding: 20px;
                border: 1px solid #888;
                width: 50%; /* Could be more or less, depending on screen size */
            }
            /* The Close Button */
            .close {
                color: #aaaaaa;
                float: right;
                font-size: 28px;
                font-weight: bold;
            }
            .close:hover,
            .close:focus {
                color: #000;
                text-decoration: none;
                cursor: pointer;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h2 class="text-center mb-4">手術記錄查詢</h2>
            <div class="row justify-content-center">
                <div class="col-md-11 col-lg-9">
                    <div class="mb-3 d-flex">
                        <input
                            type="text"
                            class="form-control"
                            name="t1"
                            placeholder="輸入關鍵字"
                        />
                        <button
                            type="button"
                            onclick="searchRecords()"
                            class="btn btn-danger"
                        >
                            查詢
                        </button>
                        <button
                            type="button"
                            onclick="searchRecords(true)"
                            class="btn btn-primary"
                        >
                            ChatGPT
                        </button>
                    </div>
                    <div id="loading" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table">
                            <thead class="table-light">
                                <tr>
                                    <th>手術序號</th>
                                    <th>病歷號</th>
                                    <th>手術細節</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Search results will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="summaryModal" class="modal">
                        <div class="modal-content">
                            <span class="close" onclick="closeSummary()"
                                >&times;</span
                            >
                            <p id="summaryText">摘要內容</p>
                        </div>
                    </div>
                    <div class="error" id="error-message"></div>
                </div>
            </div>
        </div>

        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ"
            crossorigin="anonymous"
        ></script>
        <script>
            function searchRecords(fullDisplay = false) {
                let keyword = document.querySelector('input[name="t1"]').value;
                document.getElementById("loading").style.display = "block";

                fetch("/search-results", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        keyword: keyword,
                        full_display: fullDisplay,
                    }),
                })
                    .then((response) => response.json())
                    .then((records) => {
                        document.getElementById("loading").style.display =
                            "none";
                        let tableBody = document.querySelector("tbody");
                        let tableHead = document.querySelector("thead tr");

                        // 清除現有的表格內容
                        tableBody.innerHTML = "";

                        // 如果 fullDisplay 為 true，則顯示額外的欄位標題
                        if (fullDisplay) {
                            // 添加額外欄位的標題到 <thead>
                            tableHead.innerHTML = `
                <th>手術序號</th>
                <th>病歷號</th>
                <th>手術細節</th>
                <th>手術名稱與術後診斷</th>
                <th>患者準備與手術場地準備</th>
                <th>手術進入與操作</th>
                <th>傷口處理與手術結尾</th>
                <!-- 根據需求添加更多欄位 -->
            `;
                        } else {
                            // 只顯示基本的欄位標題
                            tableHead.innerHTML = `
                <th>手術序號</th>
                <th>病歷號</th>
                <th>手術細節</th>
            `;
                        }

                        // 處理每條記錄並添加到表格中
                        records.forEach((record) => {
                            let tr = document.createElement("tr");
                            tr.innerHTML = `
                <td>${record.ODR_LOGN}</td>
                <td>${record.ODR_CHRT}</td>
                <td>${record.ODR_OPP}</td>
                ${
                    fullDisplay
                        ? `<td>${record.ODR_PREP}</td>
                           <td>${record.ODR_OPER}</td>
                           <td>${record.ODR_WCL}</td>
                           <td>${record.ODR_PNPD}</td>`
                        : ""
                }
            `;
                            tableBody.appendChild(tr);
                        });
                    })
                    .catch((error) => {
                        document.getElementById("loading").style.display =
                            "none";
                        console.error("Error:", error);
                        let errorMessage =
                            document.getElementById("error-message");
                        errorMessage.textContent =
                            "無法載入數據，請檢查後端服務。"; // Display error message
                    });
            }

            function showSummary(summary) {
                let summaryModal = document.getElementById("summaryModal");
                let summaryText = document.getElementById("summaryText");
                summaryText.textContent = summary; // Set the summary text
                summaryModal.style.display = "block"; // Show the modal
            }

            function closeSummary() {
                let summaryModal = document.getElementById("summaryModal");
                summaryModal.style.display = "none"; // Hide the modal
            }
        </script>
    </body>
</html>
